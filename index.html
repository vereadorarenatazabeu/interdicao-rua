<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solicitação de Interdição de Rua - Praia Grande</title>
    <style>
        /* Estilos básicos para o formulário */
        body { font-family: Arial, sans-serif; background-color: #f4f4f4; padding: 20px; }
        .container { max-width: 800px; margin: auto; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 0 10px rgba(0, 0, 0, 0.1); }
        h1 { text-align: center; color: #0056b3; }
        h2 { border-bottom: 2px solid #ccc; padding-bottom: 10px; margin-top: 30px; margin-bottom: 20px; color: #333; }
        label { display: block; margin-top: 10px; font-weight: bold; }
        input[type="text"], input[type="date"], input[type="time"], textarea {
            width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;
        }
        button { background-color: #0056b3; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; margin-top: 20px; font-size: 16px; transition: background-color 0.3s; }
        button:hover { background-color: #004494; }
        .btn-copy { background-color: #28a745 !important; margin-top: 5px !important; }
        .btn-copy:hover { background-color: #1e7e34 !important; }
        .alert { padding: 15px; margin-top: 20px; border-radius: 4px; text-align: center; }
        .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6fb; }
        .loading { display: none; text-align: center; margin-top: 20px; color: #0056b3; font-weight: bold; }
        .cep-status { font-size: 12px; margin-top: 2px; }
        .cep-status.loading { color: #0056b3; }
        .cep-status.error { color: #d32f2f; }
        .cep-status.success { color: #28a745; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Prefeitura de Praia Grande - Solicitação de Interdição de Rua</h1>
        <p>Preencha os dados abaixo para gerar o requerimento.</p>
        
        <form id="interdicaoForm">

            <h2>1. Dados do Solicitante</h2>
            <label for="nome_solicitante">Nome Completo:</label>
            <input type="text" id="nome_solicitante" name="nome_solicitante" required>

            <label for="rg_solicitante">RG:</label>
            <input type="text" id="rg_solicitante" name="rg_solicitante" required>

            <label for="cpf_solicitante">CPF:</label>
            <input type="text" id="cpf_solicitante" name="cpf_solicitante" required>

            <label for="telefone_solicitante">Telefone:</label>
            <input type="text" id="telefone_solicitante" name="telefone_solicitante" required>

            <label for="cep_solicitante">CEP:</label>
            <input type="text" id="cep_solicitante" name="cep_solicitante" required oninput="mascarar(this,'cep')" onblur="buscarCep()" placeholder="Somente números">
            <div id="cep-status" class="cep-status"></div>
            
            <label for="rua_solicitante">Rua:</label>
            <input type="text" id="rua_solicitante" name="rua_solicitante" required>
            
            <label for="numero_solicitante">Número:</label>
            <input type="text" id="numero_solicitante" name="numero_solicitante" required>

            <label for="bairro_solicitante">Bairro:</label>
            <input type="text" id="bairro_solicitante" name="bairro_solicitante" required>
            
            <h2>2. Detalhes da Interdição</h2>
            
            <button type="button" onclick="copiarEndereco()" class="btn-copy">
                Usar Mesmo Endereço
            </button>
            <br>
            
            <label for="rua_interdicao">Rua a ser Interditada:</label>
            <input type="text" id="rua_interdicao" name="rua_interdicao" required>

            <label for="numero_interdicao">Número:</label>
            <input type="text" id="numero_interdicao" name="numero_interdicao" required>
            
            <label for="bairro_interdicao">Bairro:</label>
            <input type="text" id="bairro_interdicao" name="bairro_interdicao" required>

            <label for="num_inicio">Trecho Compreendido (Do nº):</label>
            <input type="text" id="num_inicio" name="num_inicio" required>

            <label for="num_fim">Trecho Compreendido (Ao nº):</label>
            <input type="text" id="num_fim" name="num_fim" required>

            <label for="dia_interdicao">Dia da Interdição:</label>
            <input type="date" id="dia_interdicao" name="dia_interdicao" required>

            <label for="hora_inicio">Horário de Início (das - Ex: 08:00):</label>
            <input type="time" id="hora_inicio" name="hora_inicio" required>

            <label for="hora_fim">Horário de Término (às - Ex: 22:00):</label>
            <input type="time" id="hora_fim" name="hora_fim" required>

            <label for="motivo">Evento (Descrever o motivo) - Máx. 200 caracteres:</label>
            <textarea id="motivo" name="motivo" maxlength="200" required></textarea>
            
            <button type="submit">Enviar</button>
        </form>

        <div id="loading" class="loading">Aguarde...</div>
        <div id="responseMessage"></div>
    </div>

    <script>
        // Função de máscara para o CEP
        function mascarar(input,tipo){
            let v = input.value.replace(/\D/g,'');
            if(tipo==='cep'){ 
                if(v.length>5)v=v.slice(0,5)+'-'+v.slice(5,8); 
                input.value=v;
                
                // Se digitou 8 números, mostra "Buscando CEP..." imediatamente
                if(v.replace(/\D/g,'').length === 8) {
                    let statusElement = document.getElementById('cep-status');
                    statusElement.className = 'cep-status loading';
                    statusElement.textContent = 'Buscando CEP...';
                }
            }
        }

        // Função para copiar o endereço do solicitante para a interdição
        function copiarEndereco() {
            const rua_sol = document.getElementById('rua_solicitante').value;
            const num_sol = document.getElementById('numero_solicitante').value;
            const bairro_sol = document.getElementById('bairro_solicitante').value;

            document.getElementById('rua_interdicao').value = rua_sol;
            document.getElementById('numero_interdicao').value = num_sol;
            document.getElementById('bairro_interdicao').value = bairro_sol;
        }

        // Função para buscar o CEP usando o endpoint doGet
        function buscarCep(){
            const cepInput = document.getElementById('cep_solicitante');
            const ruaInput = document.getElementById('rua_solicitante');
            const bairroInput = document.getElementById('bairro_solicitante');
            
            if(!cepInput || !ruaInput || !bairroInput) return;
            
            const cep = cepInput.value.replace(/\D/g,'');
            if(cep.length !== 8) return;

            ruaInput.value = '';
            bairroInput.value = '';

            let statusElement = document.getElementById('cep-status');
            statusElement.className = 'cep-status loading';
            statusElement.textContent = 'Buscando CEP...';

            ruaInput.disabled = true;
            bairroInput.disabled = true;

            // URL do Apps Script Web App
            const APPS_SCRIPT_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxQhT8ZYpRe3uXOJqVEQB0Op3706ZtctuvhfWW3RMPhWEia83pFfAmZ3TkBUdWjobXP/exec';
            
            fetch(`${APPS_SCRIPT_WEB_APP_URL}?acao=buscarCep&cep=${cep}`)
                .then(response => response.json())
                .then(res => {
                    ruaInput.disabled = false;
                    bairroInput.disabled = false;
                    
                    if (res.erro) {
                        statusElement.className = 'cep-status error';
                        statusElement.textContent = 'CEP não encontrado. Preencha manualmente.';
                    } else {
                        // Preenche os valores
                        ruaInput.value = res.endereco || '';
                        bairroInput.value = res.bairro || '';
                        
                        // Dispara o evento 'input' para que o JavaScript reconheça a mudança
                        ruaInput.dispatchEvent(new Event('input', { bubbles: true }));
                        bairroInput.dispatchEvent(new Event('input', { bubbles: true }));
                        
                        statusElement.className = 'cep-status success';
                        statusElement.textContent = '✓ Endereço encontrado';
                        setTimeout(() => { 
                            statusElement.textContent = '';
                            statusElement.className = 'cep-status';
                        }, 3000);
                    }
                })
                .catch(err => {
                    ruaInput.disabled = false;
                    bairroInput.disabled = false;
                    
                    console.error('Erro na chamada do servidor:', err);
                    statusElement.className = 'cep-status error';
                    statusElement.textContent = 'Erro ao buscar CEP. Preencha manualmente.';
                });
        }

        document.getElementById('interdicaoForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const form = e.target;
            const data = {};
            new FormData(form).forEach((value, key) => data[key] = value);

            const loadingDiv = document.getElementById('loading');
            const responseDiv = document.getElementById('responseMessage');
            
            responseDiv.innerHTML = '';
            loadingDiv.style.display = 'block';

            // URL DO SEU APPS SCRIPT DEPLOYADO
            const APPS_SCRIPT_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxQhT8ZYpRe3uXOJqVEQB0Op3706ZtctuvhfWW3RMPhWEia83pFfAmZ3TkBUdWjobXP/exec'; 
            
            fetch(APPS_SCRIPT_WEB_APP_URL, {
                method: 'POST',
                mode: 'no-cors', 
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: new URLSearchParams(data).toString()
            })
            .then(() => {
                loadingDiv.style.display = 'none';
                responseDiv.innerHTML = '<div class="success">Sucesso!</div>';
            })
            .catch(error => {
                console.error('Erro ao enviar dados:', error);
                loadingDiv.style.display = 'none';
                responseDiv.innerHTML = '<div class="error">Ocorreu um erro ao enviar os dados. Verifique a URL do Apps Script e o console do navegador.</div>';
            });
        });
    </script>
</body>
</html>
